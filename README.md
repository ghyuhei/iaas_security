# Security Hub Exposure Findings Checker

AWS Security Hubã§Exposure FindingãŒæ¤œå‡ºã•ã‚ŒãŸéš›ã«ã€EventBridgeçµŒç”±ã§Lambdaã‚’è‡ªå‹•å®Ÿè¡Œã—ã€å®Ÿéš›ã®åŒ¿åã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½æ€§ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚

## ğŸ¯ æ¦‚è¦

- **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œçŸ¥**: Security Hub Exposure Findingæ¤œå‡ºæ™‚ã«è‡ªå‹•å®Ÿè¡Œ
- **å®Ÿéš›ã®ãƒ†ã‚¹ãƒˆ**: è¨­å®šç¢ºèªã§ã¯ãªãå®Ÿéš›ã®åŒ¿åã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
- **SNSé€šçŸ¥**: çµæœã‚’SNSçµŒç”±ã§Amazon Q Developer â†’ Teamsã«è‡ªå‹•é€šçŸ¥
- **8ã¤ã®ãƒªã‚½ãƒ¼ã‚¹å¯¾å¿œ**: AWSå…¬å¼å¯¾å¿œãƒªã‚½ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—ã®ã¿

## ğŸ“‹ å¯¾å¿œãƒªã‚½ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—

[AWSå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.aws.amazon.com/securityhub/latest/userguide/exposure-fidnings-adv-resource-types.html)ã®8ã¤ã®ãƒªã‚½ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—ï¼š

| ãƒªã‚½ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ— | ãƒ†ã‚¹ãƒˆå†…å®¹ |
|-------------|----------|
| `AWS::EC2::Instance` | HTTP/HTTPSæ¥ç¶šã€TCPãƒãƒ¼ãƒˆ(22,80,443,3389) |
| `AWS::RDS::DBInstance` | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒ¼ãƒˆæ¥ç¶šãƒ†ã‚¹ãƒˆ |
| `AWS::S3::Bucket` | åŒ¿åHTTP GET ãƒªã‚¯ã‚¨ã‚¹ãƒˆ |
| `AWS::Lambda::Function` | Function URL HTTPæ¥ç¶š |
| `AWS::ECS::Service` | è¨­å®šç¢ºèªï¼ˆLoad Balancerè¦ç¢ºèªï¼‰ |
| `AWS::EKS::Cluster` | Kubernetes API HTTPæ¥ç¶š |
| `AWS::DynamoDB::Table` | è¨­å®šç¢ºèªï¼ˆç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ï¼‰ |
| `AWS::IAM::User` | è¨­å®šç¢ºèªï¼ˆç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ï¼‰ |

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
Security Hub â†’ EventBridge â†’ Lambda â†’ SNS â†’ Amazon Q Developer â†’ Teams
     â†“             â†“          â†“        â†“           â†“              â†“
Exposure Finding  è‡ªå‹•ãƒˆãƒªã‚¬ãƒ¼  ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ  é€šçŸ¥    è§£æãƒ»è»¢é€        Teamsé€šçŸ¥
```

## ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹æ³•

### 1. å‰ææ¡ä»¶

- AWS CLIè¨­å®šæ¸ˆã¿
- Terraformå®Ÿè¡Œæ¨©é™
- SNS Topic ARN (Amazon Q Developerè¨­å®šæ¸ˆã¿)

### 2. ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ

```bash
# SNS Topic ARNè¨­å®š
export SNS_TOPIC_ARN="arn:aws:sns:ap-northeast-1:123456789012:security-alerts"

# Terraformã§ãƒ‡ãƒ—ãƒ­ã‚¤
./deploy.sh

# ã¾ãŸã¯æ‰‹å‹•ã§Terraformå®Ÿè¡Œ
terraform init
terraform plan
terraform apply
```

## ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
.
â”œâ”€â”€ lambda_function.py           # Lambdaé–¢æ•°ãƒ¡ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‰
â”œâ”€â”€ main.tf                     # Terraformãƒ¡ã‚¤ãƒ³è¨­å®š
â”œâ”€â”€ terraform.tfvars.example    # Terraformå¤‰æ•°ä¾‹
â”œâ”€â”€ deploy.sh                   # ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â”œâ”€â”€ test_lambda.py              # ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â””â”€â”€ README.md                   # ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«
```

## ğŸ§ª ãƒ†ã‚¹ãƒˆæ–¹æ³•

### 1. çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

```bash
# å…¨æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
python test_lambda.py
```

### 2. æ‰‹å‹•ãƒ†ã‚¹ãƒˆ

```bash
# ãƒ†ã‚¹ãƒˆã‚¤ãƒ™ãƒ³ãƒˆä½œæˆ
cat > test-event.json << 'EOF'
{
  "detail-type": "Security Hub Findings - Imported",
  "source": "aws.securityhub",
  "detail": {
    "findings": [{
      "Id": "test-finding",
      "Title": "Test Exposure Finding",
      "Type": ["Exposure"],
      "Severity": {"Label": "HIGH"},
      "Resources": [{
        "Type": "AWS::S3::Bucket",
        "Id": "arn:aws:s3:::test-bucket"
      }]
    }]
  }
}
EOF

# Lambdaå®Ÿè¡Œ
aws lambda invoke \
  --function-name SecurityHubExposureChecker \
  --payload file://test-event.json \
  response.json

cat response.json
```

### 3. å®Ÿéš›ã®Exposure Findingä½œæˆ

Security Hubã§å®Ÿéš›ã®Exposure FindingãŒç”Ÿæˆã•ã‚Œã‚‹ã¨è‡ªå‹•ã§å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

## ğŸ“Š å‹•ä½œä¾‹

### Lambdaå®Ÿè¡Œçµæœ

```json
{
  "statusCode": 200,
  "body": {
    "message": "Success",
    "processed_count": 1,
    "results": [
      {
        "finding_id": "arn:aws:securityhub:...:finding/12345",
        "title": "Publicly accessible S3 bucket",
        "severity": "HIGH",
        "timestamp": "2025-01-01T12:00:00",
        "is_accessible": true,
        "test_results": [
          {
            "resource_type": "AWS::S3::Bucket",
            "resource_id": "arn:aws:s3:::my-public-bucket",
            "is_accessible": true,
            "details": {
              "accessible_endpoint": "https://my-public-bucket.s3.amazonaws.com/",
              "method": "HTTP",
              "status_code": 200
            }
          }
        ]
      }
    ]
  }
}
```

### SNSé€šçŸ¥ä¾‹

```
Subject: Security Hub Exposure Alert: 1ä»¶ã®åŒ¿åã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãƒªã‚½ãƒ¼ã‚¹

ğŸ”’ Security Hub Exposure Finding Alert
å®Ÿè¡Œæ™‚åˆ»: 2025-01-01 12:00:00 UTC

ğŸ“Š æ¤œæŸ»çµæœã‚µãƒãƒªãƒ¼:
- æ¤œæŸ»æ¸ˆã¿Findings: 1ä»¶
- åŒ¿åã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½: 1ä»¶
- ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯: 0ä»¶

ğŸš¨ åŒ¿åã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªãƒªã‚½ãƒ¼ã‚¹:

1. Publicly accessible S3 bucket (é‡è¦åº¦: HIGH)
   ğŸ¯ AWS::S3::Bucket: my-public-bucket
   ğŸ”— ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: https://my-public-bucket.s3.amazonaws.com/

ğŸ“ è©³ç´°æƒ…å ±:
CloudWatch Logsã§ã‚ˆã‚Šè©³ç´°ãªæƒ…å ±ã‚’ç¢ºèªã§ãã¾ã™:
/aws/lambda/SecurityHubExposureChecker

Generated by AWS Security Hub Exposure Checker
```

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ãƒ­ã‚°ç¢ºèª

```bash
# ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°ç›£è¦–
aws logs tail /aws/lambda/SecurityHubExposureChecker --follow

# ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°æ¤œç´¢
aws logs filter-log-events \
  --log-group-name /aws/lambda/SecurityHubExposureChecker \
  --filter-pattern "ERROR"
```

### æ¨©é™ã‚¨ãƒ©ãƒ¼

Lambdaå®Ÿè¡Œãƒ­ãƒ¼ãƒ«ã«å¿…è¦ãªæ¨©é™ï¼š

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "ec2:DescribeInstances",
        "rds:DescribeDBInstances",
        "lambda:GetFunctionUrlConfig",
        "eks:DescribeCluster",
        "ecs:DescribeServices"
      ],
      "Resource": "*"
    }
  ]
}
```

### EventBridgeé€£æºç¢ºèª

```bash
# EventBridgeãƒ«ãƒ¼ãƒ«ç¢ºèª
aws events describe-rule --name SecurityHubExposureFindingRule

# Lambdaæ¨©é™ç¢ºèª
aws lambda get-policy --function-name SecurityHubExposureChecker
```

## ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

- **æœ€å°æ¨©é™**: å¿…è¦æœ€å°é™ã®AWSæ¨©é™ã®ã¿
- **æ©Ÿå¯†æƒ…å ±**: SNS Topic ARNã¯ç’°å¢ƒå¤‰æ•°ã§ç®¡ç†
- **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯**: ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰é€šä¿¡ã®ã¿ä½¿ç”¨

## ğŸ—‘ï¸ å‰Šé™¤æ–¹æ³•

```bash
# Terraformã§å‰Šé™¤
terraform destroy

# ç¢ºèª
terraform show
```

## ğŸ“ ã‚µãƒãƒ¼ãƒˆ

å•é¡Œã‚„ã”è³ªå•ãŒã‚ã‚‹å ´åˆï¼š

1. CloudWatch Logsã§ã‚¨ãƒ©ãƒ¼ç¢ºèª
2. IAMæ¨©é™ã®ç¢ºèª
3. EventBridgeãƒ«ãƒ¼ãƒ«ã®å‹•ä½œç¢ºèª
4. SNS Topic ARNã®æœ‰åŠ¹æ€§ç¢ºèª