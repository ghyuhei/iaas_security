# Security Hub Exposure Findings Checker

AWS Security HubでExposure Findingが検出された際に、EventBridge経由でLambdaを自動実行し、実際の匿名アクセス可能性をテストするソリューションです。

## 🎯 概要

- **リアルタイム検知**: Security Hub Exposure Finding検出時に自動実行
- **実際のテスト**: 設定確認ではなく実際の匿名アクセステストを実行
- **SNS通知**: 結果をSNS経由でAmazon Q Developer → Teamsに自動通知
- **8つのリソース対応**: AWS公式対応リソースタイプのみ

## 📋 対応リソースタイプ

[AWS公式ドキュメント](https://docs.aws.amazon.com/securityhub/latest/userguide/exposure-fidnings-adv-resource-types.html)の8つのリソースタイプ：

| リソースタイプ | テスト内容 |
|-------------|----------|
| `AWS::EC2::Instance` | HTTP/HTTPS接続、TCPポート(22,80,443,3389) |
| `AWS::RDS::DBInstance` | データベースポート接続テスト |
| `AWS::S3::Bucket` | 匿名HTTP GET リクエスト |
| `AWS::Lambda::Function` | Function URL HTTP接続 |
| `AWS::ECS::Service` | 設定確認（Load Balancer要確認） |
| `AWS::EKS::Cluster` | Kubernetes API HTTP接続 |
| `AWS::DynamoDB::Table` | 設定確認（直接アクセス不可） |
| `AWS::IAM::User` | 設定確認（直接アクセス不可） |

## 🏗️ アーキテクチャ

```
Security Hub → EventBridge → Lambda → SNS → Amazon Q Developer → Teams
     ↓             ↓          ↓        ↓           ↓              ↓
Exposure Finding  自動トリガー  アクセステスト  通知    解析・転送        Teams通知
```

## 🚀 デプロイ方法

### 1. 前提条件

- AWS CLI設定済み
- Terraform実行権限
- SNS Topic ARN (Amazon Q Developer設定済み)

### 2. デプロイ実行

```bash
# SNS Topic ARN設定
export SNS_TOPIC_ARN="arn:aws:sns:ap-northeast-1:123456789012:security-alerts"

# Terraformでデプロイ
./deploy.sh

# または手動でTerraform実行
terraform init
terraform plan
terraform apply
```

## 📁 ファイル構成

```
.
├── lambda_function.py           # Lambda関数メインコード
├── main.tf                     # Terraformメイン設定
├── terraform.tfvars.example    # Terraform変数例
├── deploy.sh                   # デプロイスクリプト
├── test_lambda.py              # テストスクリプト
└── README.md                   # このファイル
```

## 🧪 テスト方法

### 1. 統合テスト実行

```bash
# 全機能テスト
python test_lambda.py
```

### 2. 手動テスト

```bash
# テストイベント作成
cat > test-event.json << 'EOF'
{
  "detail-type": "Security Hub Findings - Imported",
  "source": "aws.securityhub",
  "detail": {
    "findings": [{
      "Id": "test-finding",
      "Title": "Test Exposure Finding",
      "Type": ["Exposure"],
      "Severity": {"Label": "HIGH"},
      "Resources": [{
        "Type": "AWS::S3::Bucket",
        "Id": "arn:aws:s3:::test-bucket"
      }]
    }]
  }
}
EOF

# Lambda実行
aws lambda invoke \
  --function-name SecurityHubExposureChecker \
  --payload file://test-event.json \
  response.json

cat response.json
```

### 3. 実際のExposure Finding作成

Security Hubで実際のExposure Findingが生成されると自動で実行されます。

## 📊 動作例

### Lambda実行結果

```json
{
  "statusCode": 200,
  "body": {
    "message": "Success",
    "processed_count": 1,
    "results": [
      {
        "finding_id": "arn:aws:securityhub:...:finding/12345",
        "title": "Publicly accessible S3 bucket",
        "severity": "HIGH",
        "timestamp": "2025-01-01T12:00:00",
        "is_accessible": true,
        "test_results": [
          {
            "resource_type": "AWS::S3::Bucket",
            "resource_id": "arn:aws:s3:::my-public-bucket",
            "is_accessible": true,
            "details": {
              "accessible_endpoint": "https://my-public-bucket.s3.amazonaws.com/",
              "method": "HTTP",
              "status_code": 200
            }
          }
        ]
      }
    ]
  }
}
```

### SNS通知例

```
Subject: Security Hub Exposure Alert: 1件の匿名アクセス可能リソース

🔒 Security Hub Exposure Finding Alert
実行時刻: 2025-01-01 12:00:00 UTC

📊 検査結果サマリー:
- 検査済みFindings: 1件
- 匿名アクセス可能: 1件
- アクセス不可: 0件

🚨 匿名アクセス可能なリソース:

1. Publicly accessible S3 bucket (重要度: HIGH)
   🎯 AWS::S3::Bucket: my-public-bucket
   🔗 アクセス可能エンドポイント: https://my-public-bucket.s3.amazonaws.com/

📝 詳細情報:
CloudWatch Logsでより詳細な情報を確認できます:
/aws/lambda/SecurityHubExposureChecker

Generated by AWS Security Hub Exposure Checker
```

## 🔧 トラブルシューティング

### ログ確認

```bash
# リアルタイムログ監視
aws logs tail /aws/lambda/SecurityHubExposureChecker --follow

# エラーログ検索
aws logs filter-log-events \
  --log-group-name /aws/lambda/SecurityHubExposureChecker \
  --filter-pattern "ERROR"
```

### 権限エラー

Lambda実行ロールに必要な権限：

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "ec2:DescribeInstances",
        "rds:DescribeDBInstances",
        "lambda:GetFunctionUrlConfig",
        "eks:DescribeCluster",
        "ecs:DescribeServices"
      ],
      "Resource": "*"
    }
  ]
}
```

### EventBridge連携確認

```bash
# EventBridgeルール確認
aws events describe-rule --name SecurityHubExposureFindingRule

# Lambda権限確認
aws lambda get-policy --function-name SecurityHubExposureChecker
```

## 🔐 セキュリティ

- **最小権限**: 必要最小限のAWS権限のみ
- **機密情報**: SNS Topic ARNは環境変数で管理
- **ネットワーク**: アウトバウンド通信のみ使用

## 🗑️ 削除方法

```bash
# Terraformで削除
terraform destroy

# 確認
terraform show
```

## 📞 サポート

問題やご質問がある場合：

1. CloudWatch Logsでエラー確認
2. IAM権限の確認
3. EventBridgeルールの動作確認
4. SNS Topic ARNの有効性確認